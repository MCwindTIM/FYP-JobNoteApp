{"ast":null,"code":"import _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport * as React from \"react\";\nimport View from \"react-native-web/dist/exports/View\";\nimport Text from \"react-native-web/dist/exports/Text\";\nimport SafeAreaView from \"react-native-web/dist/exports/SafeAreaView\";\nimport ScrollView from \"react-native-web/dist/exports/ScrollView\";\nimport StyleSheet from \"react-native-web/dist/exports/StyleSheet\";\nimport TouchableOpacity from \"react-native-web/dist/exports/TouchableOpacity\";\nimport ChatListItem from \"../../components/ChatListItem.js\";\nimport AvatarImage from \"../../components/Avatar.js\";\nimport { useFocusEffect } from \"@react-navigation/native\";\nimport { AuthContext } from \"../../components/context\";\nimport io from \"socket.io-client\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nexport default function ChatScreen(_ref) {\n  var navigation = _ref.navigation,\n      route = _ref.route;\n\n  var _React$useContext = React.useContext(AuthContext),\n      getUserData = _React$useContext.getUserData,\n      getAPIServiceURL = _React$useContext.getAPIServiceURL;\n\n  var _React$useState = React.useState([]),\n      _React$useState2 = _slicedToArray(_React$useState, 2),\n      chats = _React$useState2[0],\n      setChats = _React$useState2[1];\n\n  var _React$useState3 = React.useState(false),\n      _React$useState4 = _slicedToArray(_React$useState3, 2),\n      hasConnection = _React$useState4[0],\n      setConnection = _React$useState4[1];\n\n  var _React$useState5 = React.useState(null),\n      _React$useState6 = _slicedToArray(_React$useState5, 2),\n      lastUpdateTime = _React$useState6[0],\n      setLastUpdateTime = _React$useState6[1];\n\n  var ioEndPoint = getAPIServiceURL() + \"/\";\n  var socket = io(ioEndPoint, {\n    transports: [\"websocket\"],\n    auth: {\n      _id: getUserData()._id\n    }\n  });\n  useFocusEffect(React.useCallback(function () {\n    navigation.setOptions({\n      headerTitle: \"Chats\",\n      headerTitleAlign: \"left\",\n      headerLeft: function headerLeft() {\n        return _jsx(View, {\n          style: {\n            marginLeft: 20\n          },\n          children: _jsx(TouchableOpacity, {\n            activeOpacity: 0.5,\n            children: _jsx(AvatarImage, {\n              size: 40,\n              uri: window.CustomVar_avatar\n            })\n          })\n        });\n      }\n    });\n    socket.connect();\n    socket.io.on(\"open\", function () {\n      return setConnection(true);\n    });\n    socket.io.on(\"close\", function () {\n      return setConnection(false);\n    });\n    socket.on(\"time-msg\", function (data) {});\n    socket.emit(\"getChatRoomData\");\n    socket.on(\"chatRoomData\", function _callee2(data) {\n      var chatRoomID, filter_result;\n      return _regeneratorRuntime.async(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              if (!data.success) {\n                _context2.next = 9;\n                break;\n              }\n\n              setChats(data.data);\n\n              if (!(window.CustomVar_forwardChatRoomID !== null || window.CustomVar_forwardChatRoomID !== undefined)) {\n                _context2.next = 9;\n                break;\n              }\n\n              chatRoomID = window.CustomVar_forwardChatRoomID;\n              window.CustomVar_forwardChatRoomID = null;\n              _context2.next = 7;\n              return _regeneratorRuntime.awrap(Promise.all(data.data.filter(function _callee(chatRoom) {\n                return _regeneratorRuntime.async(function _callee$(_context) {\n                  while (1) {\n                    switch (_context.prev = _context.next) {\n                      case 0:\n                        _context.next = 2;\n                        return _regeneratorRuntime.awrap(chatRoom._id);\n\n                      case 2:\n                        _context.t0 = _context.sent;\n                        _context.t1 = chatRoomID;\n                        return _context.abrupt(\"return\", _context.t0 === _context.t1);\n\n                      case 5:\n                      case \"end\":\n                        return _context.stop();\n                    }\n                  }\n                }, null, null, null, Promise);\n              })));\n\n            case 7:\n              filter_result = _context2.sent;\n              enterChat(filter_result[0]);\n\n            case 9:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, null, null, null, Promise);\n    });\n    return function () {\n      socket.disconnect();\n      socket.removeAllListeners();\n    };\n  }, [navigation]));\n\n  var enterChat = function enterChat(chatRoomData) {\n    navigation.navigate(\"Conversation\", {\n      chatRoomData: chatRoomData\n    });\n  };\n\n  React.useEffect(function () {\n    var KeepAlive = setInterval(function () {\n      socket.emit(\"getChatRoomData\");\n    }, 1000);\n    return KeepAlive;\n  }, [navigation]);\n  return _jsx(SafeAreaView, {\n    style: {\n      backgroundColor: \"#fff\"\n    },\n    children: _jsx(ScrollView, {\n      style: styles.container,\n      children: chats.map(function (item) {\n        return _jsx(ChatListItem, {\n          id: item._id,\n          chatRoomData: item,\n          enterChat: enterChat\n        }, item._id);\n      })\n    })\n  });\n}\nvar styles = StyleSheet.create({\n  container: {\n    height: \"100%\"\n  }\n});","map":{"version":3,"sources":["D:/VTC files/Github/Assignment/fyp/ReactNative/JobApp/navigation/screens/ChatScreen.js"],"names":["React","ChatListItem","AvatarImage","useFocusEffect","AuthContext","io","ChatScreen","navigation","route","useContext","getUserData","getAPIServiceURL","useState","chats","setChats","hasConnection","setConnection","lastUpdateTime","setLastUpdateTime","ioEndPoint","socket","transports","auth","_id","useCallback","setOptions","headerTitle","headerTitleAlign","headerLeft","marginLeft","window","CustomVar_avatar","connect","on","data","emit","success","CustomVar_forwardChatRoomID","undefined","chatRoomID","Promise","all","filter","chatRoom","filter_result","enterChat","disconnect","removeAllListeners","chatRoomData","navigate","useEffect","KeepAlive","setInterval","backgroundColor","styles","container","map","item","StyleSheet","create","height"],"mappings":"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","sourcesContent":["import * as React from \"react\";\r\nimport {\r\n    View,\r\n    Text,\r\n    SafeAreaView,\r\n    ScrollView,\r\n    StyleSheet,\r\n    TouchableOpacity,\r\n} from \"react-native\";\r\nimport ChatListItem from \"../../components/ChatListItem.js\";\r\nimport AvatarImage from \"../../components/Avatar.js\";\r\nimport { useFocusEffect } from \"@react-navigation/native\";\r\n\r\nimport { AuthContext } from \"../../components/context\";\r\n//TODO: Ascending order\r\nimport io from \"socket.io-client\";\r\n\r\nexport default function ChatScreen({ navigation, route }) {\r\n    const { getUserData, getAPIServiceURL } = React.useContext(AuthContext);\r\n    const [chats, setChats] = React.useState([]);\r\n\r\n    const [hasConnection, setConnection] = React.useState(false);\r\n    const [lastUpdateTime, setLastUpdateTime] = React.useState(null);\r\n    const ioEndPoint = `${getAPIServiceURL()}/`;\r\n    const socket = io(ioEndPoint, {\r\n        transports: [\"websocket\"],\r\n        auth: {\r\n            _id: getUserData()._id,\r\n        },\r\n    });\r\n    useFocusEffect(\r\n        React.useCallback(() => {\r\n            navigation.setOptions({\r\n                headerTitle: \"Chats\",\r\n                headerTitleAlign: \"left\",\r\n                headerLeft: () => (\r\n                    <View style={{ marginLeft: 20 }}>\r\n                        <TouchableOpacity activeOpacity={0.5}>\r\n                            <AvatarImage\r\n                                size={40}\r\n                                uri={window.CustomVar_avatar}\r\n                            ></AvatarImage>\r\n                        </TouchableOpacity>\r\n                    </View>\r\n                ),\r\n            });\r\n            socket.connect();\r\n            socket.io.on(\"open\", () => setConnection(true));\r\n            socket.io.on(\"close\", () => setConnection(false));\r\n            socket.on(\"time-msg\", (data) => {\r\n                // debug\r\n                // console.log(new Date(data.time).toString());\r\n                // setLastUpdateTime(data.time);\r\n            });\r\n            socket.emit(\"getChatRoomData\");\r\n            socket.on(\"chatRoomData\", async (data) => {\r\n                if (data.success) {\r\n                    setChats(data.data);\r\n                    if (\r\n                        window.CustomVar_forwardChatRoomID !== null ||\r\n                        window.CustomVar_forwardChatRoomID !== undefined\r\n                    ) {\r\n                        //forward function\r\n                        let chatRoomID = window.CustomVar_forwardChatRoomID;\r\n                        //reset global chatRoomID\r\n                        window.CustomVar_forwardChatRoomID = null;\r\n                        const filter_result = await Promise.all(\r\n                            data.data.filter(async (chatRoom) => {\r\n                                return (await chatRoom._id) === chatRoomID;\r\n                            })\r\n                        );\r\n                        enterChat(filter_result[0]);\r\n                    }\r\n                }\r\n            });\r\n            return () => {\r\n                //on unFocus\r\n                socket.disconnect();\r\n                socket.removeAllListeners();\r\n            };\r\n        }, [navigation])\r\n    );\r\n\r\n    const enterChat = (chatRoomData) => {\r\n        navigation.navigate(\"Conversation\", {\r\n            chatRoomData: chatRoomData,\r\n        });\r\n    };\r\n\r\n    React.useEffect(() => {\r\n        const KeepAlive = setInterval(() => {\r\n            socket.emit(\"getChatRoomData\");\r\n        }, 1000);\r\n        return KeepAlive;\r\n    }, [navigation]);\r\n\r\n    return (\r\n        <SafeAreaView style={{ backgroundColor: \"#fff\" }}>\r\n            <ScrollView style={styles.container}>\r\n                {chats.map((item) => (\r\n                    <ChatListItem\r\n                        id={item._id}\r\n                        chatRoomData={item}\r\n                        key={item._id}\r\n                        enterChat={enterChat}\r\n                    ></ChatListItem>\r\n                ))}\r\n                {/* <ChatListItem /> */}\r\n            </ScrollView>\r\n        </SafeAreaView>\r\n    );\r\n}\r\n\r\nconst styles = StyleSheet.create({\r\n    container: {\r\n        height: \"100%\",\r\n    },\r\n});\r\n"]},"metadata":{},"sourceType":"module"}